pipeline {
    agent any

    environment {
        AWS_ACCOUNT_ID      = "546274484332"
        AWS_ECR_REPO_NAME   = "frontend"
        AWS_DEFAULT_REGION  = "us-east-1"
        REPOSITORY_URI      = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/alfarmur/Java-springboot-project.git'
            }
        }

        stage('Docker Build & Push') {
            agent {
                docker {
                    image 'docker:24.0.5-dind'
                    args '--privileged -u 0:0 -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }

            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'aws-access-key',
                    usernameVariable: 'AWS_ACCESS_KEY_ID',
                    passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                )]) {
                    sh '''
                        apk update
                        apk add --no-cache curl unzip python3 py3-pip
                        pip3 install awscli

                        docker --version
                        aws --version

                        cd frontend
                        docker build -t frontend-app .

                        aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | \
                        docker login --username AWS --password-stdin ${REPOSITORY_URI}

                        docker tag frontend-app ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}
                        docker push ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}
                    '''
                }
            }
        }

        stage('Update Kubernetes Deployment YAML') {
            environment {
                GIT_REPO_NAME = "Java-springboot-project"
                GIT_USER_NAME = "alfarmur"
            }
            steps {
                dir('kubernetes-files') {
                    withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'git_token')]) {
                        sh '''
                        ls -la
                        if [ ! -f frontend-deploy-service-yaml ]; then
                          echo "ERROR: frontend-deploy-service-yaml not found!"
                          exit 1
                        fi

                        git config user.email "yamar2k@yahoo.com"
                        git config user.name "alfarmur"

                        sed -i "s#image:.*#image: ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}#g" frontend-deploy-service-yaml

                        git add frontend-deploy-service-yaml
                        git commit -m "Update frontend image to ${BUILD_NUMBER}"
                        git push https://${git_token}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main
                        '''
                    }
                }
            }
        }

    }
}
